var de=Object.defineProperty,ge=Object.defineProperties;var ye=Object.getOwnPropertyDescriptors;var k=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable;var R=(e,t,o)=>t in e?de(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,v=(e,t)=>{for(var o in t||(t={}))ue.call(t,o)&&R(e,o,t[o]);if(k)for(var o of k(t))me.call(t,o)&&R(e,o,t[o]);return e},U=(e,t)=>ge(e,ye(t));var V="post-message-action";function fe(e){return e.type===V&&typeof e.action=="object"}function F(e,t){function o(){return typeof e=="function"?e():e}function n(i){let s=o();!s||i.origin!==s.origin||i.source!==s||(fe(i.data)?t(i.data.action):console.warn("Unknown message received",i.data))}function a(){window.removeEventListener("message",n)}function r(i){let s=o();if(!s)return;let p={type:V,action:i};s.postMessage(p,s.origin)}return window.addEventListener("message",n),{dispose:a,sendAction:r}}var L="boolean",Y="integer",B="float",N="string",E="input",j="dropdown",H="checkbox";function Ce(e){return function(o){return(o==null?void 0:o.type)===e}}function he(e){return function(o){let n=[e,o].join(" ");function a(r){return{type:n,payload:r}}return a.type=n,a.match=Ce(n),a}}var Te="[ext]",u=he(Te),W=u("icons-loaded"),b=u("control-selected"),G=u("select-control"),z=u("delete-property-changes"),$=u("outline-changed"),X=u("change-property"),J=u("property-changed"),q=u("change-property-failed"),S=u("change-stack-modified");async function K(e){let t;try{t=await Q(e)}catch{console.error(`Error in getting document for ${e}`)}return t}async function Q(e){let t=await Pe(e);if(t){let o=t.baseType;if(o){let n=await Q(o);return Object.assign({},n,t.properties)}return Object.assign(Object.assign({},t.properties))}else return t}async function Pe(e){let t,o={method:"GET",cache:"force-cache",headers:{"Content-Type":"application/xml"}},n;try{n=await fetch(jQuery.sap.getModulePath(e,".control"),o)}catch{console.error("Error in fetching control metadata")}if((n==null?void 0:n.status)===200){let a=await n.text(),i=new DOMParser().parseFromString(a,"application/xml");t=ve(i.documentElement,e)}return t}function ve(e,t){let o=e.children,n=Ee(o),a={baseType:ee(n,t),doc:Ie(o),properties:{}},r=xe(e.children,"properties"),i=r==null?void 0:r.children;return be(i).forEach(p=>{a.properties[p.propertyName]=v({},p)}),a}function Ee(e){var n,a;let t=e.length,o="";for(let r=0;r<t;r++)if(e&&e.item(r)&&((n=e.item(r))==null?void 0:n.tagName)==="baseType"){o=((a=e.item(r))==null?void 0:a.innerHTML)||"";break}return o}function be(e){var o,n,a,r;let t=[];for(let i in e){let s={propertyName:"",type:"",defaultValue:"",description:"",propertyType:""},p=parseInt(i);s.propertyName=((o=e==null?void 0:e.item(p))==null?void 0:o.getAttribute("name"))||"",s.type=ee(((n=e==null?void 0:e.item(p))==null?void 0:n.getAttribute("type"))||"string")||"",s.description=te(((a=e==null?void 0:e.item(p))==null?void 0:a.textContent)||"")||"",s.defaultValue=((r=e==null?void 0:e.item(p))==null?void 0:r.getAttribute("defaultValue"))||"-",s.propertyType=Se(s.type),t.push(s)}return t}function Ie(e){return te(Oe(e))}function xe(e,t){var a;let o=e.length,n=null;for(let r=0;r<o;r++)if(e&&e.item(r)&&((a=e.item(r))==null?void 0:a.tagName)===t){n=e.item(r);break}return n}function Oe(e){var n,a;let t=e.length,o="";for(let r=0;r<t;r++)if(e&&e.item(r)&&((n=e.item(r))==null?void 0:n.tagName)==="documentation"){o=((a=e.item(r))==null?void 0:a.textContent)||"";break}return o}var Z="boolean int float number function object string void any",Ne=Z+" Element Control Component";function ee(e,t){if(!e)return"";if(e.indexOf("/")!==-1)return e.replace(/\//g,".");if(e.indexOf(".")===-1&&Ne.indexOf(e)!==-1)return"sap.ui.core."+e;if(t)return t.split(".").slice(0,-1).concat([e.replace(/\//g,".")]).join(".")}function te(e){return e.replace(new RegExp("<[^>]*>","g"),"")}function Se(e){if(e){let t=e.replace(/^sap\.ui\.core\./,"");return Z.indexOf(t.replace("[]",""))!==-1?t:e}}var ne=e=>{let t=e.replace(/([A-Z])/g," $1");return t.charAt(0).toUpperCase()+t.slice(1)};var we=/src|.*icon$|^icon.*/i;function Ae(e){let t={primitiveType:"any",ui5Type:null,enumValues:null,isArray:!1};if(!e)return;let o=e.getType();if(!o)return;let n=o.getName();if(!!n){if(n.indexOf("[]")>0)t.primitiveType=n.substring(0,n.indexOf("[]")),t.isArray=!0;else if(n==="void"||n==="object")t.primitiveType=n;else if(n==="any")t.primitiveType="any";else if(n==="boolean"||n==="string"||n==="int"||n==="float")t.primitiveType=n;else{let a=window.sap.ui.base.DataType,r=a.getType(n);if(r&&!(r instanceof a))return t;let i=Object.getPrototypeOf(r).getName();i?t.primitiveType=i:t.primitiveType="enum",t.ui5Type=n,t.primitiveType==="enum"&&(t.enumValues=jQuery.sap.getObject(t.ui5Type))}return t}}function _e(e){return!(e.isArray||e.primitiveType==="any")}function Me(e){if(typeof e=="object"&&e instanceof Object&&!Array.isArray(e))try{return JSON.stringify(e)}catch(t){return t instanceof Error&&t.message.toLowerCase().includes("converting circular structure to json")?"<Circular JSON cannot be displayed>":e}else return typeof e=="function"?"":e}async function m(e,t,o=!0){let n=e.getMetadata(),a=n.getName(),r=sap.ui.fl.Utils.checkControlId(e),i=t?t.getDesignTimeMetadata().getData().properties:void 0,s=n.getAllProperties(),p=Object.keys(s),c=[],d=o?await K(a):{};for(let g of p){let l=s[g],y=Ae(l);if(!y)continue;let _=!1;i&&i[l.name]&&(_=i[l.name].ignore);let O={id:e.getId(),name:l.name,newValue:e.getProperty(l.name)},P=e.getBindingInfo(O.name);(P==null?void 0:P.bindingString)!==void 0&&(O.newValue=P.bindingString);let f=((t==null?void 0:t.isSelectable())??!1)&&_e(y)&&r&&!_,C=Me(O.newValue),ce=we.test(l.name)&&a!=="sap.m.Image"&&y.ui5Type==="sap.ui.core.URI",h=d&&d[l.name]?d[l.name]:{defaultValue:l.defaultValue||"-",description:"",propertyName:l.name,type:y.ui5Type,propertyType:y.ui5Type},T=ne(l.name);switch(y.primitiveType){case"enum":{let M=y.enumValues??{},le=Object.keys(M).map(D=>({key:D,text:M[D]}));c.push({type:N,editor:j,name:l.name,readableName:T,value:C,isEnabled:f,options:le,documentation:h});break}case"string":{c.push({type:N,editor:E,name:l.name,readableName:T,value:C,isEnabled:f,isIcon:ce,documentation:h});break}case"int":{c.push({type:Y,editor:E,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}case"float":{c.push({type:B,editor:E,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}case"boolean":{c.push({type:L,editor:H,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}}}return{id:e.getId(),type:a,properties:c.sort((g,l)=>g.name>l.name?1:-1),name:a}}var oe=async(e="")=>{let t=!1,o=sap.ui.getCore().byId(e);if(o){let n=sap.ui.dt.OverlayRegistry.getOverlay(o);(!n||!n.getDomRef())&&(n=sap.ui.dt.OverlayUtil.getClosestOverlayFor(o)),n&&(t=(await m(n.getElementInstance(),n,!1)).properties.find(i=>i.isEnabled===!0)!==void 0)}else{let n=sap.ui.getCore().getComponent(e);if(n){let r=(await m(n,void 0,!1)).properties.find(i=>i.isEnabled===!0);t=!1}}return t};async function w(e,t){let o=[...e],n=[];for(;o.length;){let a=o.shift(),r=await oe(a==null?void 0:a.id);if((a==null?void 0:a.type)==="element"){let i=(a.elements??[]).flatMap(c=>c.type==="aggregation"?c.elements??[]:[]),{text:s}=t(a.id),p={controlId:a.id,controlType:a.technicalName,name:s??a.technicalName.split(".").slice(-1)[0],editable:r,visible:a.visible??!0,children:await w(i,t)};n.push(p)}}return n}async function re(e,t){let o=await e.getService("outline");async function n(){let a=await o.get(),r=await w(a,i=>{let s=sap.ui.getCore().byId(i);if(s&&s.getMetadata().getProperty("text")){let p=s.getProperty("text");return typeof p=="string"&&p.trim()!==""?{text:p}:{}}return{}});t($(r))}o.attachEvent("update",n)}function ae(){return{getControlById:De,getIcons:Ve,getComponent:ke,getOverlay:Re,getClosestOverlayFor:Ue}}function De(e){return sap.ui.getCore().byId(e)}function ke(e){return sap.ui.getCore().getComponent(e)}function Re(e){return sap.ui.dt.OverlayRegistry.getOverlay(e)}function Ue(e){return sap.ui.dt.OverlayUtil.getClosestOverlayFor(e)}function Ve(){return sap.ui.core.IconPool.getIconNames("undefined").map(e=>{let t=sap.ui.core.IconPool.getIconInfo(e);return{name:e.toLowerCase(),content:t.content,fontFamily:t.fontFamily}}).sort((e,t)=>e.name<t.name?-1:e.name>t.name?1:0)}function A(e){let t={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)};fetch("./control-property-editor/report-telemetry",t).then(async o=>{console.log(o)}).catch(o=>{console.error("There was an error!",o)})}var I=class{constructor(t,o){this.rta=t;this.ui5=o;this.appliedChangeCache=new Map;this.activeChangeHandlers=new Set}init(t,o){let n=new Set;this.rta.attachSelectionChange(this.createOnSelectionChangeHandler(t,n)),o(async a=>{if(G.match(a)){let r=a.payload,i=this.ui5.getControlById(r);if(!i){let c=this.ui5.getComponent(r);if(c){let d=await m(c),g=b(d);t(g)}return}n.add("outline");let s=this.ui5.getOverlay(i),p=this.rta.getSelection();if(p.length>0)for(let c=0;c<p.length;c++)p[c].setSelected(!1);if((!s||!s.getDomRef())&&(s=this.ui5.getClosestOverlayFor(i)),s&&s.isSelectable())s.setSelected(!0);else{let c=await m(i),d=b(c);t(d)}}})}applyControlPropertyChange(t,o){let n=ie(t,o);this.appliedChangeCache.set(n,Date.now())}createOnSelectionChangeHandler(t,o){return async n=>{let a=n.getParameter("selection");for(let r of this.activeChangeHandlers)r();if(this.activeChangeHandlers.clear(),Array.isArray(a)&&a.length===1){let r=this.ui5.getControlById(a[0].getId());if(r){let i=r.getElementInstance(),s=i.getMetadata().getName();this.handlePropertyChanges(i,t);try{let p=o.has("outline"),c=s.toLowerCase().startsWith("sap")?s:"Other Control Types";p?A({category:"Outline Selection",controlName:c}):A({category:"Overlay Selection",controlName:c})}catch(p){console.error("Error in reporting telemetry",p)}finally{let p=await m(i,r),c=b(p);t(c),o.delete("outline")}}}}}handlePropertyChanges(t,o){let n=a=>{let r=a.getParameter("name"),i=a.getParameter("id"),s=ie(i,r);if(this.appliedChangeCache.get(s)){this.appliedChangeCache.delete(s);return}let c=t.getBindingInfo(r),d=(c==null?void 0:c.bindingString)??a.getParameter("newValue"),g=J({controlId:i,propertyName:r,newValue:d});o(g)};t.attachEvent("_change",n),this.activeChangeHandlers.add(()=>{try{t.detachEvent("_change",n)}catch{}})}};function ie(e,t){return[e,t].join(",")}var Fe="FE_FROM_SCRATCH";async function pe(e,t){let{layer:o,componentId:n,rta:a,generator:r}=e,i=sap.ui.getCore().byId(t.controlId);if(!i)return;let s={layer:o,developerMode:!0,baseId:n,projectId:"",scenario:Fe},p=typeof t.value=="string"&&se(t.value)?"BindProperty":"Property",c=typeof t.value=="string"&&se(t.value)?{propertyName:t.propertyName,newBinding:t.value}:{propertyName:t.propertyName,newValue:t.value},d=await sap.ui.rta.command.CommandFactory.getCommandFor(i,p,c,null,s);d.getPreparedChange().getDefinition().support.generator=r,await a.getCommandStack().pushAndExecute(d)}function se(e){return e.startsWith("{")&&e.endsWith("}")}var x=class{constructor(t,o,n){this.options=t;this.ui5=o;this.selectionService=n;this.savedChanges=[]}async init(t,o){o(async r=>{if(X.match(r))try{this.selectionService.applyControlPropertyChange(r.payload.controlId,r.payload.propertyName),await pe(this.options,r.payload)}catch(i){let s="",p=r.payload.controlId||"",c=this.ui5.getControlById(p);c&&(s=c.getMetadata().getName());let g=Le(i==null?void 0:i.toString(),p,s)||`RTA Exception applying expression "${r.payload.value}"`,l=q(U(v({},r.payload),{errorMessage:g}));t(l)}else z.match(r)&&await this.deleteChange(r.payload.controlId,r.payload.propertyName,r.payload.fileName)});let n=await fetch(`/FioriTools/api/getChanges?_=${Date.now()}`).then(r=>r.json()).catch(console.error),a=Object.keys(n??{}).map(r=>{let i=n[r];try{if(Ye(["fileName","selector.id","content.property","creation"],i),[i.content.newValue,i.content.newBinding].every(s=>s==null))throw new Error("Invalid change, missing new value in the change file");return{type:"saved",kind:"valid",fileName:i.fileName,controlId:i.selector.id,propertyName:i.content.property,value:i.content.newValue??i.content.newBinding,timestamp:new Date(i.creation).getTime(),controlName:i.selector.type.split(".").pop()}}catch(s){if(i.fileName){let p={type:"saved",kind:"unknown",fileName:i.fileName};return i.creation&&(p.timestamp=new Date(i.creation).getTime()),p}console.error(s);return}}).filter(r=>!!r).sort((r,i)=>i.timestamp-r.timestamp);this.savedChanges=a,t(S({saved:a,pending:[]})),this.options.rta.attachUndoRedoStackModified(this.createOnStackChangeHandler(t))}async deleteChange(t,o,n){let a=this.savedChanges.filter(r=>n?n===r.fileName:r.controlId===t&&r.propertyName===o).map(r=>fetch("/FioriTools/api/removeChanges",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:r.fileName})}));await Promise.all(a).catch(console.error)}createOnStackChangeHandler(t){return async()=>{let o=this.options.rta.getCommandStack(),n=o.getCommands(),a=o.getAllExecutedCommands(),r=n.length-a.length,i=n.map(function(s,p){try{let c=s.getProperty("selector"),d=s.getProperty("changeType"),g="";switch(d){case"propertyChange":g=s.getProperty("newValue");break;case"propertyBindingChange":g=s.getProperty("newBinding");break}return{type:"pending",controlId:c.id,propertyName:s.getProperty("propertyName"),isActive:p>=r,value:g,controlName:s.getElement().getMetadata().getName().split(".").pop()??""}}catch(c){console.error(c)}}).filter(s=>!!s);t(S({saved:this.savedChanges,pending:i}))}}};function Le(e,t,o){return e.replace("Error: Applying property changes failed:","").replace(`${o}#${t}`,"")}function Ye(e,t){for(let o of e){let n=Be(o,t);if(n==null)throw new Error(`Invalid change, missing ${o} in the change file`)}}function Be(e,t){let o=e.split("."),n=t;for(let a of o)n=n[a];return n}function je(e){console.log("Initializing Control Property Editor");let{rta:t}=e,o=ae(),n=[];function a(p){n.push(p)}let r=new I(t,o),i=new x(e,o,r),s=[r,i];try{let{sendAction:p}=F(window.parent,async function(g){for(let l of n)try{await l(g)}catch(y){console.error(y)}});for(let d of s)d.init(p,a);re(t,p);let c=o.getIcons();p(W(c))}catch(p){console.error("Error during initialization of Control Property Editor",p)}}export{je as init};
//# sourceMappingURL=ui5-adaptation.js.map
